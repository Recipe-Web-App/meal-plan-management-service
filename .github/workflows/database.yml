name: Database

on:
  push:
    branches: [main, develop]
    paths:
      - 'prisma/**'
      - '.github/workflows/database.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'prisma/**'

jobs:
  prisma-check:
    name: Prisma Schema Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Prisma generate
        run: bunx prisma generate

      - name: Prisma format check
        run: bunx prisma format --check

      - name: Prisma validate
        run: bunx prisma validate

  migration-test:
    name: Migration Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:18@sha256:b6b4d0b75c699a2c94dfc5a94fe09f38630f3b67ab0e1653ede1b7ac8e13c197
        env:
          POSTGRES_PASSWORD: test_password # pragma: allowlist secret
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Prisma generate
        run: bunx prisma generate

      - name: Run migrations
        run: bunx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db # pragma: allowlist secret

      - name: Seed database (if seed script exists)
        run: |
          if bun run 2>&1 | grep -q "db:seed"; then
            bun run db:seed
          else
            echo "No seed script found, skipping..."
          fi
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db # pragma: allowlist secret

  database-backup:
    name: Database Backup Strategy Test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Test backup script
        run: |
          # This would test your backup strategy
          echo "Testing database backup procedures..."
          # Add your backup testing logic here

  schema-diff:
    name: Schema Diff Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout base branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          path: pr

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: |
          cd pr
          bun install --frozen-lockfile

      - name: Generate schema diff
        run: |
          cd pr
          bunx prisma generate
          # Compare schema files
          if ! diff -u ../base/prisma/schema.prisma prisma/schema.prisma > schema-diff.txt; then
            echo "Schema changes detected:"
            cat schema-diff.txt
            # You could use a tool like Atlas or Prisma's diff tool here
          else
            echo "No schema changes detected"
          fi

      - name: Comment PR with schema changes
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const path = './pr/schema-diff.txt';

            if (fs.existsSync(path)) {
              const diff = fs.readFileSync(path, 'utf8');
              if (diff.trim()) {
                const body = `## üóÑÔ∏è Database Schema Changes Detected\n\n\`\`\`diff\n${diff}\n\`\`\`\n\n` +
                           `‚ö†Ô∏è Please review these schema changes carefully before merging.`;
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                });
              }
            }
